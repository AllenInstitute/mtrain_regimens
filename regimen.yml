
_change_detection_script: &change_detection_script
    http://stash.corp.alleninstitute.org/projects/VB/repos/visual_behavior_scripts/raw/change_detection_with_fingerprint.py?at=021ec55fbbdbb05aad1681c016e83066fe5aa1dd

_change_detection_script_md5: &change_detection_script_md5
    e0535f3b6f03ccc8eeccaed2118f3c1d

_movie_clips_script: &movie_clips_script
    http://stash.corp.alleninstitute.org/projects/ENG/repos/cam2p_scripts/raw/behavior/integration_testing/9_receptive_field_characterization/MovieClips.py?at=ec6f7d4abfe150ea793a7db14b84ca9418c1f649

_movie_clips_script_md5: &movie_clips_script_md5
    f3d68b1708d34fb75e01ae34af7e24a6

_full_field_gratings_stimulus: &full_field_gratings
    class: grating OPHYS_0_images_A_habituation
    params:
        sf: 0.04
        tex: sqr
        size: [200, 150,]
        units: deg
        phase: 0.25
    groups:
        vertical:
            Ori: [0, 180]
        horizontal:
            Ori: [90, 270]

_image_set_a_stimulus: &image_set_a
    class: images
    params:
        # image_set: //allen/aibs/mpe/Software/stimulus_files/nimages_0_20170714.zip
        image_set: //allen/programs/braintv/workgroups/nc-ophys/Doug/Stimulus_Code/image_dictionaries/Natural_Images_Lum_Matched_set_TRAINING_2017.07.14.pkl
        sampling: even

_image_set_b_stimulus: &image_set_b
    class: images
    params:
        image_set: //allen/programs/braintv/workgroups/nc-ophys/Doug/Stimulus_Code/image_dictionaries/Natural_Images_Lum_Matched_set_ophys_3_2017.07.14.pkl
        sampling: even

_image_set_c_stimulus: &image_set_c
    class: images
    params:
        image_set: //allen/programs/braintv/workgroups/nc-ophys/Doug/Stimulus_Code/image_dictionaries/Natural_Images_Lum_Matched_set_ophys_6_2017.07.14.pkl
        sampling: even

_image_set_d_stimulus: &image_set_d
    class: images
    params:
        image_set: //allen/programs/braintv/workgroups/nc-ophys/Doug/Stimulus_Code/image_dictionaries/Natural_Images_Lum_Matched_set_ophys_5_2017.07.14.pkl
        sampling: even

_countdown_movie: &countdown_movie
    name: countdown
    params:
        movie_path: //allen/programs/braintv/workgroups/nc-ophys/Justin/Outbox/countdown_30fps.npy
        frame_length: 0.03333333333333333
        size: [1920, 1080]

_fingerprint_movie: &fingerprint_movie
    name: fingerprint
    params:
        movie_path: //allen/programs/braintv/workgroups/neuralcoding/Saskia/Visual Stimuli 151207/Movie_TOE1.npy
        frame_length: 0.03333333333333333
        size: [1920, 1080]
        runs: 10


_flash_parameters: &flash_parameters
    task_id: DoC

    catch_frequency: 0.25
    failure_repeats: 5

    # rewards (mL)
    reward_volume: 0.007
    volume_limit: 5.0

    # auto rewards
    auto_reward_vol: 0.005
    warm_up_trials: 5
    auto_reward_delay: 0.150
    free_reward_trials: 10000

    # trial timing
    min_no_lick_time: 0.0
    timeout_duration: 0.3
    pre_change_time: 0.0
    stimulus_window: 6.0
    max_task_duration_min: 60.0
    start_stop_padding: 20.0
    periodic_flash: [0.25, 0.5]
    response_window: [0.15,0.75]
    end_after_response: True
    end_after_response_sec: 3.5

    # timing of changes
    change_time_dist: geometric
    change_time_scale: 0.3
    change_flashes_min: 4  # inclusive
    change_flashes_max: 12  # exclusive

_no_flash_parameters: &no_flash_parameters
    <<: *flash_parameters
    periodic_flash: null
    response_window: [0.15,1.0]
    reward_volume: 0.010
    free_reward_trials: 10
    pre_change_time: 2.25

    # timing of changes
    change_time_dist: exponential
    change_time_scale: 2.0
    change_flashes_min: null
    change_flashes_max: null


_image_set_a_parameters: &image_set_a_parameters
    <<: *flash_parameters
    stimulus: *image_set_a
    catch_frequency: null

_image_set_b_parameters: &image_set_b_parameters
    <<: *flash_parameters
    stimulus: *image_set_b
    catch_frequency: null

_image_set_c_parameters: &image_set_c_parameters
    <<: *flash_parameters
    stimulus: *image_set_c
    catch_frequency: null

_image_set_d_parameters: &image_set_d_parameters
    <<: *flash_parameters
    stimulus: *image_set_d
    catch_frequency: null

### mtrain definitions

name: VisualBehavior_Task1A_v1.0.2

transitions:

  - trigger: progress
    source: TRAINING_0_gratings_autorewards_15min
    dest: TRAINING_1_gratings
    conditions: one_complete

  - trigger: progress
    source: TRAINING_1_gratings
    dest: TRAINING_2_gratings_flashed
    conditions: [two_out_of_three_aint_bad, yesterday_was_good]

  - trigger: progress
    source: TRAINING_2_gratings_flashed
    dest: TRAINING_3_images_A_10uL_reward
    conditions: [two_out_of_three_aint_bad, yesterday_was_good]

  - trigger: progress
    source: TRAINING_3_images_A_10uL_reward
    dest: TRAINING_4_images_A_training
    conditions: three_complete

  - trigger: progress
    source: TRAINING_4_images_A_training
    dest: TRAINING_4_images_A_handoff_ready
    conditions: meets_engagement_criteria

  - trigger: progress
    source: TRAINING_4_images_A_handoff_ready
    dest: TRAINING_4_images_A_handoff_lapsed
    unless: meets_engagement_criteria

  - trigger: progress
    source: TRAINING_4_images_A_handoff_lapsed
    dest: TRAINING_4_images_A_handoff_ready
    conditions: meets_engagement_criteria

  - trigger: manual
    source: TRAINING_4_images_A_handoff_ready
    dest: OPHYS_0_images_A_habituation

  - trigger: manual
    source: OPHYS_0_images_A_habituation
    dest: OPHYS_1_images_A

  - trigger: manual
    source: OPHYS_1_images_A
    dest: OPHYS_2_images_A_passive

  - trigger: manual
    source: OPHYS_2_images_A_passive
    dest: OPHYS_3_images_A

  - trigger: manual
    source: OPHYS_3_images_A
    dest: OPHYS_4_images_B

  - trigger: manual
    source: OPHYS_4_images_B
    dest: OPHYS_5_images_B_passive

  - trigger: manual
    source: OPHYS_5_images_B_passive
    dest: OPHYS_6_images_B

  - trigger: manual
    source: OPHYS_6_images_B
    dest: OPHYS_7_receptive_field_mapping

stages:

    TRAINING_0_gratings_autorewards_15min:
        script: *change_detection_script
        script_md5: *change_detection_script_md5
        parameters:
            <<: *no_flash_parameters
            stage: TRAINING_0_gratings_autorewards_15min
            stimulus: *full_field_gratings

            # auto rewards
            warm_up_trials: -1 #infinite
            abort_on_early_response: False
            catch_frequency: 0.0

            response_window: [0.0, 0.0]
            min_no_lick_time: 0.0
            failure_repeats: 0

            # trial timing
            max_task_duration_min: 15.0

            # rewards (mL)
            reward_volume: 0.0


    TRAINING_1_gratings:
        script: *change_detection_script
        script_md5: *change_detection_script_md5
        parameters:
            <<: *no_flash_parameters
            stage: TRAINING_1_gratings

            stimulus: *full_field_gratings


    TRAINING_2_gratings_flashed:
        script: *change_detection_script
        script_md5: *change_detection_script_md5
        parameters:
            <<: *flash_parameters
            stage: TRAINING_2_gratings_flashed
            task_id: DoC

            stimulus: *full_field_gratings
            free_reward_trials: 10

            # rewards (mL)
            reward_volume: 0.01


    TRAINING_3_images_A_10uL_reward:
        script: *change_detection_script
        script_md5: *change_detection_script_md5
        parameters:
            <<: *image_set_a_parameters
            stage: TRAINING_3_images_A_10uL_reward

            # rewards (mL)
            reward_volume: 0.01
            free_reward_trials: 10

    TRAINING_4_images_A_training:
        script: *change_detection_script
        script_md5: *change_detection_script_md5
        parameters:
            <<: *image_set_a_parameters
            stage: TRAINING_4_images_A_training

    TRAINING_4_images_A_handoff_ready:
        script: *change_detection_script
        script_md5: *change_detection_script_md5
        parameters:
            <<: *image_set_a_parameters
            stage: TRAINING_4_images_A_handoff_ready
            warm_up_trials: 0

    TRAINING_4_images_A_handoff_lapsed:
        script: *change_detection_script
        script_md5: *change_detection_script_md5
        parameters:
            <<: *image_set_a_parameters
            stage: TRAINING_4_images_A_handoff_lapsed
            free_reward_trials: 10

    OPHYS_0_images_A_habituation:
        script: *change_detection_script
        script_md5: *change_detection_script_md5
        parameters:
            <<: *image_set_a_parameters
            stage: OPHYS_0_images_A_habituation
            warm_up_trials: 0
            start_stop_padding: 300.0
            flash_omit_probability: 0.05
            prologue: *countdown_movie
            epilogue: *fingerprint_movie

    OPHYS_1_images_A:
        script: *change_detection_script
        script_md5: *change_detection_script_md5
        parameters:
            <<: *image_set_a_parameters
            stage: OPHYS_1_images_A
            warm_up_trials: 0
            start_stop_padding: 300.0
            flash_omit_probability: 0.05
            prologue: *countdown_movie
            epilogue: *fingerprint_movie

    OPHYS_2_images_A_passive:
        script: *change_detection_script
        script_md5: *change_detection_script_md5
        parameters:
            <<: *image_set_a_parameters
            stage: OPHYS_2_images_A_passive
            warm_up_trials: 0
            start_stop_padding: 300.0
            flash_omit_probability: 0.05
            lick_spout: False
            prologue: *countdown_movie
            epilogue: *fingerprint_movie

    OPHYS_3_images_A:
        script: *change_detection_script
        script_md5: *change_detection_script_md5
        parameters:
            <<: *image_set_a_parameters
            stage: OPHYS_3_images_A
            warm_up_trials: 0
            start_stop_padding: 300.0
            flash_omit_probability: 0.05
            prologue: *countdown_movie
            epilogue: *fingerprint_movie

    OPHYS_4_images_B:
        script: *change_detection_script
        script_md5: *change_detection_script_md5
        parameters:
            <<: *image_set_c_parameters
            stage: OPHYS_4_images_B
            warm_up_trials: 0
            start_stop_padding: 300.0
            flash_omit_probability: 0.05
            prologue: *countdown_movie
            epilogue: *fingerprint_movie

    OPHYS_5_images_B_passive:
        script: *change_detection_script
        script_md5: *change_detection_script_md5
        parameters:
            <<: *image_set_c_parameters
            stage: OPHYS_5_images_B_passive
            warm_up_trials: 0
            start_stop_padding: 300.0
            flash_omit_probability: 0.05
            lick_spout: False
            prologue: *countdown_movie
            epilogue: *fingerprint_movie

    OPHYS_6_images_B:
        script: *change_detection_script
        script_md5: *change_detection_script_md5
        parameters:
            <<: *image_set_c_parameters
            stage: OPHYS_6_images_B
            warm_up_trials: 0
            start_stop_padding: 300.0
            flash_omit_probability: 0.05
            prologue: *countdown_movie
            epilogue: *fingerprint_movie

    OPHYS_7_receptive_field_mapping:
        script: *movie_clips_script
        script_md5: *movie_clips_script_md5
        parameters:
            stage: OPHYS_7_receptive_field_mapping
