# dynamic routing task v1 development params
# used for local script development with the camstim v2 api, TODO: add a version number?

_change_detection_script: &change_detection_script change_detection_extended_v2.py

_movie_clips_script: &movie_clips_script receptive_field_mapping_v2.py

_bi_script: &bi_script bi_script_v2.py

_full_field_gratings_stimulus: &full_field_gratings
  class: grating
  params:
    sf: 0.04
    tex: sqr
    size: [200, 150]
    units: deg
    phase: 0.25
  groups:
    vertical:
      Ori: [0, 180]
    horizontal:
      Ori: [90, 270]

_image_set_g_stimulus: &image_set_g
  class: images
  luminance_matching_intensity: -0.46
  params:
    image_set: Natural_Images_Lum_Matched_set_ophys_G_2019.05.26.pkl
    sampling: even

_image_set_h_stimulus: &image_set_h
  class: images
  luminance_matching_intensity: -0.46
  params:
    image_set: Natural_Images_Lum_Matched_set_ophys_H_2019.05.26.pkl
    sampling: even

_mapping_movie_list: &mapping_movie_list
  - name: gabor
    params:
      frame_length: 0.016666666666666666
      movie_path: gabor-remastered-1576117355.npy
      runs: 5 # 1 min each run
      size: [1920, 1080]

  - name: flash
    params:
      frame_length: 0.016666666666666666
      movie_path: flash-remastered-1576272856.npy
      runs: 5 # 1 min each
      size: [1920, 1080]

_flash_parameters: &flash_parameters
  task_id: DoC

  catch_frequency: 0.25
  failure_repeats: 5

  # rewards (mL)
  reward_volume: 0.007
  volume_limit: 5.0

  # auto rewards
  auto_reward_vol: 0.005
  warm_up_trials: 5
  auto_reward_delay: 0.150
  free_reward_trials: 10000

  # trial timing
  min_no_lick_time: 0.0
  timeout_duration: 0.3
  pre_change_time: 0.0
  stimulus_window: 6.0
  max_task_duration_min: 60.0
  periodic_flash: [0.25, 0.5]
  response_window: [0.15, 0.75]
  end_after_response: True
  end_after_response_sec: 3.5

  # timing of changes
  change_time_dist: geometric
  change_time_scale: 0.3
  change_flashes_min: 4 # inclusive
  change_flashes_max: 12 # exclusive

  # start stop padding < 1 can cause a critcally breaking bug
  start_stop_padding: 1

_no_flash_parameters: &no_flash_parameters
  <<: *flash_parameters
  periodic_flash: null
  response_window: [0.15, 1.0]
  reward_volume: 0.010
  free_reward_trials: 10
  pre_change_time: 2.25

  # timing of changes
  change_time_dist: exponential
  change_time_scale: 2.0
  change_flashes_min: null
  change_flashes_max: null

_image_set_g_parameters: &image_set_g_parameters
  <<: *flash_parameters
  stimulus: *image_set_g
  catch_frequency: null

_image_set_h_parameters: &image_set_h_parameters
  <<: *flash_parameters
  stimulus: *image_set_h
  catch_frequency: null

_base_even_sampling_stimulus: &base_even_sampling_stimulus
  class: images
  luminance_matching_intensity: -0.46
  params:
    image_set: image-set-im000_r.pkl
    sampling: even

_even_sampling_parameters: &even_sampling_parameters
  omitted_go_reward_frequency: 0.0
  random_rewards: {}
  auto_reward_delay: 0.15
  auto_reward_vol: 0.005
  catch_frequency: 0.25
  flash_omit_probability: 0.05
  change_time_dist: geometric
  change_time_scale: 0.3
  failure_repeats: 5
  free_reward_trials: 10000
  max_task_duration_min: 65.0
  min_no_lick_time: 0
  periodic_flash: [0.25, 0.5]
  pre_change_time: 2.25
  response_window: [0.15, 0.75]
  start_stop_padding: 10.0
  stimulus_window: 6.0
  task_id: DoC
  timeout_duration: 0.3
  volume_limit: 5.0
  lick_on_auto_rewards: 3
  lick_disable_intervals: [[900, 2400]]
  mapping:
    flash_path: flash_250ms.stim
    gabor_path: gabor_20_deg_250ms.stim
  agent_socket: "127.0.0.1:5000"
  warm_up_trials: 5
  reward_volume: 0.005
  max_mapping_duration_min: 10
  disable_mapping_portion: False
  disable_opto_portion: True
  opto_params: # required by code despite being disabled
    test_levels: True

_bi_parameters: &bi_parameters
  <<: *even_sampling_parameters
  behavior_script: "even_sampling_script_v2_builtin.py"
  mapping_script: "mapping_script_v2.py"
  opto_script: "opto_tagging_v2.py"

_even_sampling_ephys_parameters: &even_sampling_ephys_parameters
  <<: *bi_parameters
  warm_up_trials: 3
  reward_volume: 0.005
  flash_omit_probability: 0.05
  max_mapping_duration_min: 35
  disable_opto_portion: False
  opto_params:
    operation_mode: "experiment"

_bi_base_params: &bi_base_params
  script: *bi_script
  script_md5: *bi_script # same if script is a resource id
  parameters:
    <<: *bi_parameters
    stimulus:
      <<: *base_even_sampling_stimulus
      params:
        image_set: image-set-im000_r.pkl
        sampling: even

### mtrain definitions
name: DynamicRouting_Task1_builtin_v0.0.5

transitions:
  - trigger: progress
    source: TRAINING_0_gratings_autorewards_15min_0uL_reward
    dest: TRAINING_1_gratings_10uL_reward
    conditions: one_complete

  - trigger: progress
    source: TRAINING_1_gratings_10uL_reward
    dest: TRAINING_2_gratings_flashed_10uL_reward
    conditions: [two_out_of_three_aint_bad, yesterday_was_good]

  - trigger: progress
    source: TRAINING_2_gratings_flashed_10uL_reward
    dest: TRAINING_3_images_G_10uL_reward
    conditions: [two_out_of_three_aint_bad, yesterday_was_good]

  - trigger: progress
    source: TRAINING_3_images_G_10uL_reward
    dest: TRAINING_4_images_G_training_7uL_reward
    conditions: three_complete

  - trigger: progress
    source: TRAINING_4_images_G_training_7uL_reward
    dest: TRAINING_5_images_G_epilogue_5uL_reward
    conditions: meets_engagement_criteria_logged

  - trigger: progress
    source: TRAINING_5_images_G_epilogue_5uL_reward
    dest: TRAINING_5_images_G_handoff_ready_5uL_reward
    conditions: meets_engagement_and_hit_threshold

  - trigger: progress
    source: TRAINING_5_images_G_handoff_ready_5uL_reward
    dest: TRAINING_5_images_G_handoff_lapsed_5uL_reward
    unless: meets_engagement_and_hit_threshold

  - trigger: progress
    source: TRAINING_5_images_G_handoff_lapsed_5uL_reward
    dest: TRAINING_5_images_G_handoff_ready_5uL_reward
    conditions: meets_engagement_and_hit_threshold

  - trigger: manual
    source: TRAINING_5_images_G_handoff_ready_5uL_reward
    dest: HABITUATION_0

  - trigger: progress
    source: HABITUATION_0
    dest: HABITUATION_1
    conditions: one_complete

  - trigger: progress
    source: HABITUATION_1
    dest: HABITUATION_2
    conditions: one_complete

  - trigger: progress
    source: HABITUATION_2
    dest: HABITUATION_3
    conditions: one_complete

  - trigger: progress
    source: HABITUATION_3
    dest: HABITUATION_4
    conditions: one_complete

  - trigger: progress
    source: HABITUATION_4
    dest: HABITUATION_5
    conditions: one_complete

  - trigger: progress
    source: HABITUATION_5
    dest: HABITUATION_6
    conditions: one_complete

  - trigger: progress
    source: HABITUATION_6
    dest: HABITUATION_7
    conditions: one_complete

  - trigger: progress
    source: HABITUATION_7
    dest: HABITUATION_8
    conditions: one_complete

  - trigger: progress
    source: HABITUATION_8
    dest: HABITUATION_9
    conditions: one_complete

  - trigger: progress
    source: HABITUATION_9
    dest: HABITUATION_10
    conditions: one_complete

  - trigger: progress
    source: HABITUATION_10
    dest: HABITUATION_11
    conditions: one_complete

  - trigger: progress
    source: HABITUATION_11
    dest: HABITUATION_12
    conditions: one_complete

  - trigger: manual
    source: HABITUATION_12
    dest: EPHYS_1

  - trigger: progress
    source: EPHYS_1
    dest: EPHYS_2
    conditions: one_complete

  - trigger: progress
    source: EPHYS_2
    dest: EPHYS_3
    conditions: one_complete

  - trigger: progress
    source: EPHYS_3
    dest: EPHYS_4
    conditions: one_complete

  - trigger: progress
    source: EPHYS_4
    dest: EPHYS_5
    conditions: one_complete

  - trigger: progress
    source: EPHYS_5
    dest: EPHYS_6
    conditions: one_complete

stages:
  TRAINING_0_gratings_autorewards_15min_0uL_reward:
    script: *change_detection_script
    script_md5: *change_detection_script
    parameters:
      <<: *no_flash_parameters
      stage: TRAINING_0_gratings_autorewards_15min_0uL_reward
      stimulus: *full_field_gratings

      # auto rewards
      warm_up_trials: -1 #infinite
      abort_on_early_response: False
      catch_frequency: 0.0

      response_window: [0.0, 0.0]
      min_no_lick_time: 0.0
      failure_repeats: 0

      # trial timing
      max_task_duration_min: 15.0

      # rewards (mL)
      reward_volume: 0.0

      # ephys-specific no grayscreen pre-exp time
      start_padding_windowless: 20.0

  TRAINING_1_gratings_10uL_reward:
    script: *change_detection_script
    script_md5: *change_detection_script
    parameters:
      <<: *no_flash_parameters
      stage: TRAINING_1_gratings_10uL_reward

      stimulus: *full_field_gratings

      # ephys-specific no grayscreen pre-exp time
      start_padding_windowless: 20.0

  TRAINING_2_gratings_flashed_10uL_reward:
    script: *change_detection_script
    script_md5: *change_detection_script
    parameters:
      <<: *flash_parameters
      stage: TRAINING_2_gratings_flashed_10uL_reward
      task_id: DoC

      stimulus: *full_field_gratings
      free_reward_trials: 10

      # rewards (mL)
      reward_volume: 0.01

      # ephys-specific no grayscreen pre-exp time
      start_padding_windowless: 20.0

  TRAINING_3_images_G_10uL_reward:
    script: *change_detection_script
    script_md5: *change_detection_script
    parameters:
      <<: *image_set_g_parameters
      stage: TRAINING_3_images_G_10uL_reward

      # rewards (mL)
      reward_volume: 0.01
      free_reward_trials: 10

      # ephys-specific no grayscreen pre-exp time
      start_padding_windowless: 20.0

  TRAINING_4_images_G_training_7uL_reward:
    script: *change_detection_script
    script_md5: *change_detection_script
    parameters:
      <<: *image_set_g_parameters
      stage: TRAINING_4_images_G_training_7uL_reward

      # ephys-specific no grayscreen pre-exp time
      start_padding_windowless: 20.0

  TRAINING_5_images_G_epilogue_5uL_reward:
    script: *change_detection_script
    script_md5: *change_detection_script
    parameters:
      <<: *image_set_g_parameters
      stage: TRAINING_5_images_G_epilogue_5uL_reward
      warm_up_trials: 5
      reward_volume: 0.005

      # ephys-specific no grayscreen pre-exp time
      start_padding_windowless: 300.0

      # play list of movies mimicking a mapping session
      epilogue_list: *mapping_movie_list

  TRAINING_5_images_G_handoff_ready_5uL_reward:
    script: *change_detection_script
    script_md5: *change_detection_script
    parameters:
      <<: *image_set_g_parameters
      stage: TRAINING_5_images_G_handoff_ready_5uL_reward
      warm_up_trials: 5
      reward_volume: 0.005

      # ephys-specific no grayscreen pre-exp time
      start_padding_windowless: 300.0

      # play list of movies mimicking a mapping session
      epilogue_list: *mapping_movie_list

  TRAINING_5_images_G_handoff_lapsed_5uL_reward:
    script: *change_detection_script
    script_md5: *change_detection_script
    parameters:
      <<: *image_set_g_parameters
      stage: TRAINING_5_images_G_handoff_lapsed_5uL_reward
      warm_up_trials: 5
      reward_volume: 0.005

      # ephys-specific no grayscreen pre-exp time
      start_padding_windowless: 300.0

      # play list of movies mimicking a mapping session
      epilogue_list: *mapping_movie_list

  # break
  HABITUATION_0:
    script: *change_detection_script
    script_md5: *change_detection_script
    parameters:
      <<: *image_set_g_parameters
      stage: HABITUATION_0
      warm_up_trials: 5
      reward_volume: 0.005

      # ephys-specific no grayscreen pre-exp time
      start_padding_windowless: 0.1

      # play list of movies mimicking a mapping session
      epilogue_list: *mapping_movie_list

  HABITUATION_1:
    script: *bi_script
    script_md5: *bi_script # same if script is a resource id
    parameters:
      <<: *bi_parameters
      stage: HABITUATION_1
      dev: True
      max_task_duration_min: 5
      max_mapping_duration_min: 1
      stimulus:
        <<: *base_even_sampling_stimulus

  HABITUATION_2:
    script: *bi_script
    script_md5: *bi_script # same if script is a resource id
    parameters:
      <<: *bi_parameters
      stage: HABITUATION_2
      stimulus:
        <<: *base_even_sampling_stimulus
        params:
          image_set: image-set-im031_r.pkl
          sampling: even

  HABITUATION_3:
    script: *bi_script
    script_md5: *bi_script # same if script is a resource id
    parameters:
      <<: *bi_parameters
      stage: HABITUATION_3
      stimulus:
        <<: *base_even_sampling_stimulus
        params:
          image_set: image-set-im045_r.pkl
          sampling: even

  HABITUATION_4:
    script: *bi_script
    script_md5: *bi_script # same if script is a resource id
    parameters:
      <<: *bi_parameters
      stage: HABITUATION_4
      stimulus:
        <<: *base_even_sampling_stimulus
        params:
          image_set: image-set-im054_r.pkl
          sampling: even

  HABITUATION_5:
    script: *bi_script
    script_md5: *bi_script # same if script is a resource id
    parameters:
      <<: *bi_parameters
      stage: HABITUATION_5
      stimulus:
        <<: *base_even_sampling_stimulus
        params:
          image_set: image-set-im073_r.pkl
          sampling: even

  HABITUATION_6:
    script: *bi_script
    script_md5: *bi_script # same if script is a resource id
    parameters:
      <<: *bi_parameters
      stage: HABITUATION_6
      stimulus:
        <<: *base_even_sampling_stimulus
        params:
          image_set: image-set-im106_r.pkl
          sampling: even

  HABITUATION_7:
    script: *bi_script
    script_md5: *bi_script # same if script is a resource id
    parameters:
      <<: *bi_parameters
      stage: HABITUATION_7
      stimulus:
        <<: *base_even_sampling_stimulus
        params:
          image_set: image-set-im008_r.pkl
          sampling: even

  HABITUATION_8:
    script: *bi_script
    script_md5: *bi_script # same if script is a resource id
    parameters:
      <<: *bi_parameters
      stage: HABITUATION_8
      stimulus:
        <<: *base_even_sampling_stimulus
        params:
          image_set: image-set-im029_r.pkl
          sampling: even

  HABITUATION_9:
    script: *bi_script
    script_md5: *bi_script # same if script is a resource id
    parameters:
      <<: *bi_parameters
      stage: HABITUATION_9
      stimulus:
        <<: *base_even_sampling_stimulus
        params:
          image_set: image-set-im040_r.pkl
          sampling: even

  HABITUATION_10:
    script: *bi_script
    script_md5: *bi_script # same if script is a resource id
    parameters:
      <<: *bi_parameters
      stage: HABITUATION_10
      stimulus:
        <<: *base_even_sampling_stimulus
        params:
          image_set: image-set-im046_r.pkl
          sampling: even

  HABITUATION_11:
    script: *bi_script
    script_md5: *bi_script # same if script is a resource id
    parameters:
      <<: *bi_parameters
      stage: HABITUATION_11
      stimulus:
        <<: *base_even_sampling_stimulus
        params:
          image_set: image-set-im037_r.pkl
          sampling: even

  HABITUATION_12:
    script: *bi_script
    script_md5: *bi_script # same if script is a resource id
    parameters:
      <<: *bi_parameters
      stage: HABITUATION_12
      stimulus:
        <<: *base_even_sampling_stimulus
        params:
          image_set: image-set-im053_r.pkl
          sampling: even

  EPHYS_1:
    script: *bi_script
    script_md5: *bi_script # same if script is a resource id
    parameters:
      <<: *even_sampling_ephys_parameters
      stage: EPHYS_1
      stimulus:
        <<: *base_even_sampling_stimulus
        params:
          image_set: image-set-im104_r.pkl
          sampling: even

  EPHYS_2:
    script: *bi_script
    script_md5: *bi_script # same if script is a resource id
    parameters:
      <<: *even_sampling_ephys_parameters
      stage: EPHYS_2
      stimulus:
        <<: *base_even_sampling_stimulus
        params:
          image_set: image-set-im114_r.pkl
          sampling: even

  EPHYS_3:
    script: *bi_script
    script_md5: *bi_script # same if script is a resource id
    parameters:
      <<: *even_sampling_ephys_parameters
      stage: EPHYS_3
      stimulus:
        <<: *base_even_sampling_stimulus
        params:
          image_set: image-set-im005_r.pkl
          sampling: even

  EPHYS_4:
    script: *bi_script
    script_md5: *bi_script # same if script is a resource id
    parameters:
      <<: *even_sampling_ephys_parameters
      stage: EPHYS_4
      stimulus:
        <<: *base_even_sampling_stimulus
        params:
          image_set: image-set-im087_r.pkl
          sampling: even

  EPHYS_5:
    script: *bi_script
    script_md5: *bi_script # same if script is a resource id
    parameters:
      <<: *even_sampling_ephys_parameters
      stage: EPHYS_5
      stimulus:
        <<: *base_even_sampling_stimulus
        params:
          image_set: image-set-im024_r.pkl
          sampling: even

  EPHYS_6:
    script: *bi_script
    script_md5: *bi_script # same if script is a resource id
    parameters:
      <<: *even_sampling_ephys_parameters
      stage: EPHYS_6
      stimulus:
        <<: *base_even_sampling_stimulus
        params:
          image_set: image-set-im034_r.pkl
          sampling: even
